
# Predicting True Low-VAF SNVs in the Human Papillomavirus 


<!-- TABLE OF CONTENTS -->
<details open="open">
  <summary><h2 style="display: inline-block">Table of Contents</h2></summary>
  <ol>
    <li>
      <a href="#about-the-project">About The Project</a>
    </li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#repository-contents">Repository Contents</a></li>
    <li><a href="#usage">Usage</a></li>
    <li><a href="#license">License</a></li>
    <li><a href="#contact">Contact</a></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
  </ol>
</details>


<!-- ABOUT THE PROJECT -->
## About The Project
Identifying true single nucleotide variants (SNVs) existing at low variant allele fractions (VAFs) is challenging, particularly because it is tricky to tease apart SNVs that are sequencing artifacts from genuine low-VAF SNVs. In this work, we present a novel machine learning technique to identify SNVs occurring at low-intermediate VAFs by using the human papillomavirus (HPV) as a case study.

We sequenced the HPV whole genome from 31 HPV18 positive samples in <b> triplicates (i.e., 31 samples x 3 reps per samples = 93 sequenced samples in total) </b> and used an in-house variant calling pipeline to detect variants in each sequenced sample. The variants identified were with respect to the reference HPV18 genome (NCBI Ref. ID AY262282). We labelled each variant with its <b> replicate frequency (the number of replicates of the sample in which the variant was detected) </b> and used the replicate frequency to identify true SNVs. Based on our underlying hypothesis, true SNVs would be detected in all (3/3) replicates, while false SNVs in 1/3 replicates of a sample. Consistent with our goal of detecting low-VAF variants, we restricted our study only to variants with VAF 1% - 60%. We then extracted sequencing features for each variant from the VCF file, supplemented them with features related to the 5' (5-prime) and 3' (3-prime) nucleotide contexts of the variant and trained Xtreme Gradient Boosting (XGBoost) binary classification models to predict true and false SNVs. We further complemented our supervised XGBoost models with an unsupervised approach [VCFgenie](https://github.com/chasewnelson/VCFgenie.git) and observed improved prediction performance. 

## Installation

The code in this repository is written in Python (v3.8) You will need access to a Linux terminal (even a Windows 10 having Windows Subsystem for Linux enabled and Ubuntu installed) to be able to execute the code. The specific instructions below work best in a Ubuntu 18.02/Ubuntu20.04 platform. Follow the steps below to install the required packages and run the scripts.

1. Clone the repo
```sh
  git clone https://github.com/NCI-CGR/HPV_low_VAF_SNV_prediction.git
```
2. Install miniconda
```sh
  wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  chmod +x Miniconda3-latest-Linux-x86_64.sh
  ./Miniconda3-latest-Linux-x86_64.sh
```
&ensp;&ensp;Follow the on-screen instructions to complete installation of miniconda and to initialize conda.

3. Create a conda environment

&ensp;&ensp;Create a conda environment that will include all the required packages necessary for running the repository code. We will use the <b>hpv_triplicate_env.yaml</b> file for this purpose.

```sh
  conda env create -f psp_gnm_env.yaml
```

4. Activate the conda environment
```sh
  conda activate hpv_triplicate_env
```

5. Make sure you are good to go
```sh
  cd HPV_low_VAF_SNV_prediction # go to the repo directory that you just cloned in Step 1
  python scripts/split_multi_allelic_var.py --help
```
&ensp;&ensp;The following help menu should be displayed
```sh
Usage: split_multi_allelic_var.py [OPTIONS]

Options:
  --vcf_dir TEXT                The directory containing the vcf files (with
                                the headers)  [required]
  --output_dir TEXT             The directory to which the parsed files will
                                be written  [required]
  --num_metadata_lines INTEGER  The number of meta data lines in the vcf files
                                (excluding the header line). Meta data lines
                                begin with "##". Default is 70 for the raw
                                vcfs generated by our pipeline. However, for
                                the filtered VCF files generated by VCFgenie
                                it is 86.  [required]
  --help                        Show this message and exit.
```


## Repository Contents
The contents of the repository are described below.
- <b> data/ </b>- The data directory includes the raw and the processed variant data that is required for training and testing the machine learning models. Within this directory, the <b> vcf_files/raw_vcf </b> and <b> vcf_files/vcfgenie_vcf </b> subdirectories include the raw VCFs generated by our in-house variant calling pipeline and the filtered VCFs generated upon post-filtering of the raw VCFs by [VCFgenie](https://github.com/chasewnelson/VCFgenie.git), respectively. The <b> SNV_data_wo_vcf_genie.csv </b> contains all the raw SNVs from our in-house pipeline and their features. The <b> SNV_data_with_vcf_genie.csv </b> includes SNVs extracted from the processed VCF files generated by VCFgenie. The PERCENT_OVERLAP indicates the replicate frequency of each SNV (1 => 3/3, 0.67 => 2/3, 0.33 => 1/3) and the AF is the VAF for a SNV. The HPV18_not_padded.fasta file includes the reference genome sequence for HPV18.

- <b> scripts/ </b> - The split_multi_allelic_var.py script is used to parse through a directory having VCF files, split multi-allelic positions into separate rows, only extract SNVs and their sequencing features and write the SNVs and their features into a .csv file. The data/SNV_data_wo_vcf_genie.csv and data/SNV_data_with_vcf_genie.csv files were generated using this script. Checkout the command `python scripts/split_multi_allelic_var.py --help` to explore how to use this script.

- <b> machine_learning/ </b> - This directory in general includes two pieces of code related to the machine learning used in our study. The <b> xgb_model_training_and_performance.ipynb </b> is an interactive jupyter notebook intended to guide the user through step-by-step instructions on how to reproduce the study results. It is intended to demonstrate to the user how training and testing were performed for the 3 scenarios: <b> a. Machine learning with VAF filters (FM models) </b>, <b> b. Machine learning with VCFgenie without any low-VAF filters (VM models) </b>, and <b> c. Machine learning with VCFgenie with low-VAF filters (FVM models). </b> The <b> predict_true_low_vaf_snvs.py </b> script is a more independent script that can be used for predicting true/false SNVs using the trained models (doesn't require prior model training). More on this script is elaborated in the <a href="#usage">Usage</a> section of this document.

- <b> FM_models/ </b> - Includes trained XGB models for the FM scenario. Only includes models trained for the optimum parameter/feature conditions.
- <b> VM_models/ </b> - Includes trained XGB models for the VM scenario. Only includes models trained for the optimum parameter/feature conditions.
- <b> FVM_models/ </b> - Includes trained XGB models for the FVM scenario. Only includes models trained for the optimum parameter/feature conditions.

- <b> results/ </b> - Includes performance metrics for models trained for each parameter/feature combination in each of the 3 scenarios (FM, VM and FVM). Metric files are generated upon executing the jupyter notebook (machine_learning/xgb_model_training_and_performance.ipynb).

<!-- USAGE EXAMPLES -->
## Usage

### Example 1: Reproducing study results
 To reproduce the results included in our study, simply run the jupyter notebook (machine_learning/xgb_model_training_and_performance.ipynb). For each scenario (FM, VM and FVM), the notebook will train and test XGBoost models on all possible parameter/feature combinations and write the performance metrics into results directory. To reduce run time, you can skip running the sections that correspond to saving the models for the best performing parameter/feature combinations in each scenario (i.e., the section titled <i>"Save the models for the best performing scenario - in this case the VM models" </i> and all the code following this section). These sections have already been executed and the models saved in their respective directories.

### Example 2: Predicting true SNVs using the raw VCF files
In this example, we will learn how to predict true/false SNVs using the raw VCF files generated by our in-house script.

### Example 3. Predicting true SNVs using processed VCF files generated by VCFgenie
In this example, we will learn how to predict true/false SNVs using the filtered VCF files generated by VCFgenie.


Use this space to show useful examples of how a project can be used. Additional screenshots, code examples and demos work well in this space. You may also link to more resources.

_For more examples, please refer to the [Documentation](https://example.com)_




<!-- LICENSE -->
## License

Distributed under the MIT License. See `LICENSE` for more information.



<!-- CONTACT -->
## Contact

Sambit Mishra - sambit.mishra@nih.gov

Project Link: [https://github.com/NCI-CGR/HPV_low_VAF_SNV_prediction](https://github.com/NCI-CGR/HPV_low_VAF_SNV_prediction.git)



<!-- ACKNOWLEDGEMENTS -->
## Acknowledgements
The work is an outcome of a collaborative effort between the researchers at the Cancer Genomics Research Laboratory ([CGR](https://dceg.cancer.gov/about/organization/cgr)), [Frederick National Laboratory](https://frederick.cancer.gov/) and the principal investigators and postdoctoral fellows at the Division of Cancer Epidemiology and Genetics ([DCEG](https://dceg.cancer.gov/)). I would like to acknowledge the scientific efforts and research guidance received from Dr. Lisa Mirabello, Dr. Meredith Yeager, Dr. Laurie Burdette, Dr. Michael Dean, Dr. Bin Zhu, Dr. Chase Nelson and Dr. Maisa Pinheiro without which this work wouldn't be complete.
