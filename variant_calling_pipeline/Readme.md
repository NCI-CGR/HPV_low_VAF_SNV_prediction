# Description

The directory includes <a href="https://snakemake.readthedocs.io/en/stable/"> snakemake </a> workflow scripts for performing variant calling on targeted amplicon sequencing data from the Ion Torrent platform. The input to the pipeline are the bam files generated by the Ion Torrent sequencer. The pipeline assumes that the mapping has already been performed using the Ion Torrent Suite to the reference genome (in this case the HPV18 genome). For convenience, the HPV18 genome used in our study is included (refs/HPV18.fasta). Alternatively, you can re-map the bams to the provided HPV18 genome using <a href="https://github.com/iontorrent/TS/tree/master/Analysis/TMAP"> Tmap </a>.

The pipeline will first perform a quality control on the mapped reads and only retain the high quality reads. Next, it will perform variant calling using the somatic settings for the torrent variant caller to detect within-host low-VAF variants. The output from the variant calling pipeline are the VCF files which are used in the main analysis for predicting true iSNVs.

# Installation and Execution
You will first need to download and install the <a href="https://github.com/domibel/IonTorrent-VariantCaller"> torrent variant caller (TVC)</a> and the <a href="https://pcingola.github.io/SnpEff/download/"> SNPEff annotation tool</a>. Setup the SNPEff database for HPV18. You can refer to refs/HPV18.genes.bed for HPV18 gene annotation information. Then create and activate a conda environment to install the remaining packages following the instructions below. 

```
conda env create -f hpv_variant_calling_env.yaml
conda activate hpv_variant_calling_env
```

Before running the pipeline, you will need to update the config/hpv_config.yaml file with the correct paths and update the parse_samples and parse_blanks functions in the config/config_functions.py to capture the correct sample ids. 

# Input
The workflow inputs aligned bams as designated in the hpv_config.yaml file.

# Output
The workflow outputs an annotated vcf file, a bam file filtered for just the amplicon regions, and a consensus fasta file for each sample.